var markers=[],instaLinks=[],apiDetails={clientId:"AQKR5W0CRVB4SPIE5C2XJDJJQH0IS2BWGWS3QJY0CUYL2F1F",clientSecret:"RYVS3A2URZDDZURSDNOFVXEVQWSECAXXXFFNAB1IAJY2BV0N",instagramAccessToken:"2235758096.1fb234f.984dee2be36946789a4427ff1ff7dd62"},generateDataUrl=function(a,b,c,d){var e="https://api.foursquare.com/v2/venues/search?client_id="+a+"&client_secret="+b+"&v=20130815&ll="+c.lat()+","+c.lng()+"&query="+d;return e},generateInstaUrl=function(a){var b="https://api.instagram.com/v1/tags/"+a+"/media/recent?access_token="+apiDetails.instagramAccessToken;return b},generateImageUrl=function(a,b,c){var d="https://api.foursquare.com/v2/venues/"+c+"/photos?client_id="+a+"&client_secret="+b+"&v=20130815";return d},place=function(a,b,c,d,e,f,g){var h=this;h.name=ko.observable(a),h.marker=createMarker(b,a,e,d,f,g),h.markerInfoWindowContent=generateContent(a,e,d,f,g),h.formattedAddress=ko.observable(d),h.address=ko.observable(e),h.imageIndex=ko.observable(c)},createMarker=function(a,b,c,d,e,f){var g=new google.maps.Marker({map:map,position:a,animation:google.maps.Animation.DROP,title:b,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});return g.addListener("click",function(){showMarker(g,generateContent(b,c,d,e,f)),animateMarker(g)}),markers.push(g),g},showMarker=function(a,b){infowindow.setContent(b),infowindow.open(map,a)},setMapOnAll=function(a){for(var b=0;b<markers.length;b++)markers[b].setMap(a)},animateMarker=function(a){null!==a.getAnimation()?(a.setIcon("http://maps.google.com/mapfiles/ms/icons/red-dot.png"),a.setAnimation(null)):(a.setAnimation(google.maps.Animation.BOUNCE),a.setIcon("http://maps.google.com/mapfiles/ms/icons/blue-dot.png"),setTimeout(function(){animateMarker(a)},1e3))},generateContent=function(a,b,c,d,e){var f,g='<div class="markerHeader">'+a+"</div>",h='<img class="placeHolder" src="'+d+'">',i='<div class="markerText">'+b+"</div>",j=instaLinks.length>0?'<div class="instaClass" ><a href='+instaLinks[Math.floor(Math.random()*instaLinks.length)]+' target="_blank">'+e+" @ insta</a></div></section>":"</section>";return void 0!==b?f='<section class="markerContent">'+h+g+i+j:(i='<div class="markerText">'+c+"</div>",f='<section class="markerContent">'+h+g+i+j),f},requestAjaxCall=function(a,b,c){var d=generateDataUrl(apiDetails.clientId,apiDetails.clientSecret,b,c);$.ajax({url:d,dataType:"json",timeout:3e3}).done(function(b){var d,e,f,g,h,i,j,k,l=b.response.venues;bounds=new google.maps.LatLngBounds;for(var m=0;m<l.length;m++){var n={};d=l[m],e=generateImageUrl(apiDetails.clientId,apiDetails.clientSecret,d.id),f=d.location.formattedAddress[0],g=d.location.address,n.lat=d.location.lat,n.lng=d.location.lng,0!=d.categories.length?(i=d.categories[0].icon.prefix,j=d.categories[0].icon.suffix,h=i+"32"+j):h="img/placeholder.png",k=new google.maps.LatLng(n.lat,n.lng),bounds.extend(k),a.placesArray.push(new place(d.name,n,m,f,g,h,c)),a.bindImage(e)}map.fitBounds(bounds)}).fail(function(){a.showAndHideErrorDiv(!0)}),a.bindImage=function(b){var c,d,e,f,g,h,i;$.ajax({url:b,dataType:"json",timeout:3e3}).done(function(b){g=b.response.photos.items,h=g[0],i=b.response.photos.count,i?(c=h.prefix,d="128x128",e=h.suffix,f=c+d+e):f="img/X.png",a.imagesArray.push(f)}).fail(function(){a.imagesArray.push("img/X.png")})}},requestInstagram=function(a){var b=generateInstaUrl(a);$.ajax({url:b,dataType:"jsonp",method:"GET"}).done(function(a){for(var b=a.data,c=0;c<b.length;c++)instaLinks.push(b[c].link)}).fail(function(){instaLinks.length=0})},viewModel=function(){var a=this;a.placesArray=ko.observableArray(),a.imagesArray=ko.observableArray(),a.filter=ko.observable(""),a.showAndHideList=ko.observable(!0),a.buttonText=ko.observable("Hide List ! Show Map !"),a.showAndHideModal=ko.observable(!1),a.cityInput=ko.observable(""),a.searchInput=ko.observable(""),a.showAndHideErrorDiv=ko.observable(!1),a.flag=ko.observable(1),a.getLatLng=function(){if("undefined"!=typeof geocoder){var b=a.cityInput();requestInstagram(a.searchInput()),""!=b?""!=a.searchInput()?(localStorage.setItem("searchInput",a.searchInput()),geocoder.geocode({address:b},function(c,d){var e;d==google.maps.GeocoderStatus.OK?(e=c[0].geometry.location,map.setCenter(e),a.getQuery(e,a.searchInput()),localStorage.setItem("Location",b),a.toggleModal(),a.flag(0)):alert("Geocode was not successful for the following reason: "+d)})):alert("Please enter a search item!"):alert("Please enter a city name!")}else a.showAndHideErrorDiv(!0)},a.getQuery=function(b,c){a.placesArray().length=0,a.imagesArray().length=0,instaLinks.length=0,setMapOnAll(null),markers.length=0,requestAjaxCall(a,b,c)},a.filteredItems=ko.computed(function(){var b=a.filter().toLowerCase();return b?ko.utils.arrayFilter(a.placesArray(),function(a){var c=a.name().toLowerCase().indexOf(b);return-1!=c?(a.marker.setMap(map),1):void a.marker.setMap(null)}):(setMapOnAll(map),a.placesArray())},a),a.enableMarkerHover=function(a){showMarker(a.marker,a.markerInfoWindowContent)},a.enableMarkerClick=function(a){showMarker(a.marker,a.markerInfoWindowContent),animateMarker(a.marker)},a.disableMarker=function(){infowindow.close()},a.toggleListDisplay=function(){a.showAndHideList()?(a.showAndHideList(!1),a.buttonText("Show list of places !")):(a.showAndHideList(!0),a.buttonText("Hide List ! Show Map !"))},a.toggleModal=function(){a.showAndHideModal()?a.showAndHideModal(!1):a.showAndHideModal(!0)},a.listCss=ko.pureComputed(function(){return 1==a.flag()?"listOnFirstAppearance":"list"}),a.mapCss=ko.pureComputed(function(){return 1==a.flag()?"mapOnFirstAppearance":"mapDiv"}),window.onload=function(){var b=localStorage.getItem("Location"),c=localStorage.getItem("searchInput");if(requestInstagram(c),"undefined"!=typeof geocoder)if(b&&c){var d=b;a.flag(0),geocoder.geocode({address:d},function(b,d){var e;d==google.maps.GeocoderStatus.OK?(e=b[0].geometry.location,map.setCenter(e),a.getQuery(e,c)):alert("Geocode was not successful for the following reason: "+d)})}else a.toggleModal();else a.showAndHideErrorDiv(!0)}},vm=new viewModel;ko.applyBindings(vm);