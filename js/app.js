var markers=[],createMarker,apiDetails={clientId:"AQKR5W0CRVB4SPIE5C2XJDJJQH0IS2BWGWS3QJY0CUYL2F1F",clientSecret:"RYVS3A2URZDDZURSDNOFVXEVQWSECAXXXFFNAB1IAJY2BV0N"},generateDataUrl=function(a,b,c,d){var e="https://api.foursquare.com/v2/venues/search?client_id="+a+"&client_secret="+b+"&v=20130815&ll="+c.J+","+c.M+"&query="+d;return e},generateImageUrl=function(a,b,c){var d="https://api.foursquare.com/v2/venues/"+c+"/photos?client_id="+a+"&client_secret="+b+"&v=20130815";return d},place=function(a,b,c,d,e){this.name=ko.observable(a),this.marker=createMarker(b,a,e,d),this.markerInfoWindow=createInfoWindow(a,e,d),this.formattedAddress=ko.observable(d),this.address=ko.observable(e),this.imageIndex=ko.observable(c)},createMarker=function(a,b,c,d){var e=new google.maps.Marker({map:map,position:a,animation:google.maps.Animation.DROP,title:b}),f=function(){null!==e.getAnimation()?e.setAnimation(null):(e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){f()},2e3))};return e.addListener("click",function(){var a=createInfoWindow(b,c,d);showMarker(e,a)}),e.addListener("click",f),markers.push(e),e},createInfoWindow=function(a,b,c){var d=new google.maps.InfoWindow({content:generateContent(a,b,c),width:400});return d},showMarker=function(a,b){b.open(map,a)},setMapOnAll=function(a){for(var b=0;b<markers.length;b++)markers[b].setMap(a)},generateContent=function(a,b,c){var d,e='<div class="markerHeader">'+a+"</div>",f='<img class="placeHolder" src="img/placeholder.png" />',g='<div class="markerText">'+b+"</div>";return void 0!==b?d='<section class="markerContent">'+f+e+g:(g='<div class="markerText">'+c+"</div>",d='<section class="markerContent">'+f+e+g),d},requestAjaxCall=function(a,b,c){var d=generateDataUrl(apiDetails.clientId,apiDetails.clientSecret,b,c);$.ajax({url:d,dataType:"json",timeout:3e3}).done(function(b){for(var c,d,e,f,g=b.response.venues,h={},i=0;i<g.length;i++)c=g[i],d=generateImageUrl(apiDetails.clientId,apiDetails.clientSecret,c.id),e=c.location.formattedAddress[0],f=c.location.address,h.lat=c.location.lat,h.lng=c.location.lng,a.placesArray.push(new place(c.name,h,i,e,f)),a.bindImage(d)}).fail(function(){a.showAndHideErrorDiv(!0)}),a.bindImage=function(b){var c,d,e,f,g,h,i;$.ajax({url:b,dataType:"json",timeout:3e3}).done(function(b){g=b.response.photos.items,h=g[0],i=b.response.photos.count,i?(c=h.prefix,d="128x128",e=h.suffix,f=c+d+e):f="img/X.png",a.imagesArray.push(f)}).fail(function(){a.imagesArray.push("img/X.png")})}},viewModel=function(){var a=this;a.placesArray=ko.observableArray(),a.imagesArray=ko.observableArray(),a.filter=ko.observable(""),a.showAndHideList=ko.observable(!0),a.buttonText=ko.observable("Hide List ! Show Map !"),a.showAndHideModal=ko.observable(!1),a.cityInput=ko.observable(""),a.searchInput=ko.observable(""),a.showAndHideErrorDiv=ko.observable(!1),a.flag=ko.observable(1),a.getLatLng=function(){if("undefined"!=typeof geocoder){var b=a.cityInput();""!=b?""!=a.searchInput()?(localStorage.setItem("searchInput",a.searchInput()),geocoder.geocode({address:b},function(c,d){var e;d==google.maps.GeocoderStatus.OK?(e=c[0].geometry.location,map.setCenter(e),a.getQuery(e,a.searchInput()),localStorage.setItem("Location",b),a.toggleModal(),a.flag(0)):alert("Geocode was not successful for the following reason: "+d)})):alert("Please enter a search item!"):alert("Please enter a city name!")}else a.showAndHideErrorDiv(!0)},a.getQuery=function(b,c){a.placesArray().length=0,a.imagesArray().length=0,setMapOnAll(null),markers.length=0,requestAjaxCall(a,b,c)},a.filteredItems=ko.computed(function(){var b=a.filter().toLowerCase();return b?ko.utils.arrayFilter(a.placesArray(),function(a){var c=a.name().toLowerCase().indexOf(b);return-1!=c?(a.marker.setMap(map),1):void a.marker.setMap(null)}):(setMapOnAll(map),a.placesArray())},a),a.enableMarker=function(a){showMarker(a.marker,a.markerInfoWindow)},a.disableMarker=function(a){a.markerInfoWindow.close()},a.toggleListDisplay=function(){a.showAndHideList()?(a.showAndHideList(!1),a.buttonText("Show list of places !")):(a.showAndHideList(!0),a.buttonText("Hide List ! Show Map !"))},a.toggleModal=function(){a.showAndHideModal()?a.showAndHideModal(!1):a.showAndHideModal(!0)},a.listCss=ko.pureComputed(function(){return 1==a.flag()?"listOnFirstAppearance":"list"}),a.mapCss=ko.pureComputed(function(){return 1==a.flag()?"mapOnFirstAppearance":"mapDiv"}),window.onload=function(){var b=localStorage.getItem("Location"),c=localStorage.getItem("searchInput");if("undefined"!=typeof geocoder)if(b&&c){var d=b;a.flag(0),geocoder.geocode({address:d},function(b,d){var e;d==google.maps.GeocoderStatus.OK?(e=b[0].geometry.location,map.setCenter(e),a.getQuery(e,c)):alert("Geocode was not successful for the following reason: "+d)})}else a.toggleModal();else a.showAndHideErrorDiv(!0)}};ko.applyBindings(new viewModel);